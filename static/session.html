<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeMux - AI Session</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent: #58a6ff;
            --success: #3fb950;
            --warning: #d29922;
            --error: #f85149;
            --border: #30363d;
        }
        
        body {
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .agent-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .agent-badge {
            background: var(--accent);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 70px;
            text-align: center;
        }
        
        .session-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .session-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .session-controls {
            display: flex;
            gap: 8px;
        }
        
        .control-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }
        
        .control-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin-right: 16px;
        }
        
        .back-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            text-decoration: none;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: row;
            overflow: hidden;
            position: relative;
        }
        
        .terminal-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            overflow: hidden;
        }
        
        .terminal {
            flex: 1;
            padding: 0;
            background: var(--bg-primary);
            overflow: hidden;
            position: relative;
        }
        
        #xterm-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .log-panel {
            width: 350px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
        }
        
        .log-panel.hidden {
            width: 0;
            overflow: hidden;
        }
        
        .log-header {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .log-clear {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .log-clear:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .log-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            font-size: 12px;
            line-height: 1.4;
            font-family: inherit;
        }
        
        .log-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .log-content::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        .log-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        .log-entry {
            margin-bottom: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            word-wrap: break-word;
        }
        
        .log-entry.info {
            color: var(--text-secondary);
            background: rgba(88, 166, 255, 0.1);
        }
        
        .log-entry.error {
            color: var(--error);
            background: rgba(248, 81, 73, 0.1);
        }
        
        .log-entry.success {
            color: var(--success);
            background: rgba(63, 185, 80, 0.1);
        }
        
        .log-entry.warning {
            color: var(--warning);
            background: rgba(210, 153, 34, 0.1);
        }
        
        .log-timestamp {
            font-size: 11px;
            color: var(--text-secondary);
            margin-right: 8px;
            opacity: 0.7;
        }
        
        .prompt-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 2px solid var(--accent);
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
        }
        
        .prompt-overlay.active {
            transform: translateY(0);
        }
        
        .prompt-title {
            color: var(--accent);
            font-size: 14px;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .prompt-content {
            color: var(--text-primary);
            margin-bottom: 16px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .text-input {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px 14px;
            font-family: inherit;
            font-size: 14px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .text-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }
        
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn:hover {
            background: #4493e6;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(88, 166, 255, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .choice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .choice-item {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .choice-item:hover {
            border-color: var(--accent);
            background: var(--bg-tertiary);
        }
        
        .choice-item.selected {
            border-color: var(--accent);
            background: rgba(88, 166, 255, 0.1);
        }
        
        .choice-item input {
            cursor: pointer;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .terminal-line {
            margin: 2px 0;
        }
        
        .terminal-line.ai {
            color: var(--accent);
        }
        
        .terminal-line.user {
            color: var(--success);
        }
        
        .terminal-line.system {
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .terminal-line.error {
            color: var(--error);
        }
        
        .input-bar {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 16px 20px;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .quick-input {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .quick-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }
        
        .send-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .send-btn:hover {
            background: #4493e6;
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid transparent;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <!-- DAEMON_MODE_NAV -->
            <div class="agent-info">
                <div class="agent-badge" id="agentBadge">CLAUDE</div>
                <div class="session-meta">
                    <div class="session-title">Code Agent Session</div>
                    <div class="status">
                        <div class="status-dot"></div>
                        <span id="statusText">Connected</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="session-controls">
                <button class="control-btn" onclick="clearTerminal()" title="Clear terminal">
                    <span>üóëÔ∏è</span>
                </button>
                <button class="control-btn" onclick="toggleLogs()" title="Toggle logs panel" id="logsToggle">
                    <span>üìã</span>
                </button>
                <button class="control-btn" onclick="toggleJsonl()" title="Toggle JSONL viewer" id="jsonlToggle">
                    <span>üìÑ</span>
                </button>
                <button class="control-btn" onclick="toggleSettings()" title="Settings">
                    <span>‚öôÔ∏è</span>
                </button>
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <div class="terminal-panel">
            <div class="terminal" id="terminal">
                <div id="xterm-container"></div>
            </div>
        </div>
        
        <div class="log-panel" id="logPanel">
            <div class="log-header">
                <div class="log-title">System Logs</div>
                <button class="log-clear" onclick="clearLogs()">Clear</button>
            </div>
            <div class="log-content" id="logContent">
                <!-- Logs will appear here -->
            </div>
        </div>
        
        <div class="log-panel" id="jsonlPanel" style="display: none;">
            <div class="log-header">
                <div class="log-title">Claude Session History (JSONL)</div>
                <button class="log-clear" onclick="clearJsonl()">Clear View</button>
            </div>
            <div class="log-content" id="jsonlContent" style="font-family: 'Monaco', 'Menlo', monospace; font-size: 12px;">
                <!-- JSONL content will appear here -->
            </div>
        </div>
        
        <div class="prompt-overlay" id="promptOverlay">
            <div class="prompt-title" id="promptTitle">Input Required</div>
            <div class="prompt-content" id="promptContent"></div>
            <div id="promptInput"></div>
        </div>
    </div>
    
    <div class="input-bar">
        <input 
            type="text" 
            class="quick-input" 
            id="quickInput" 
            placeholder="Type your message to the code agent..."
            autocomplete="off"
        />
        <button class="send-btn" id="sendBtn" onclick="sendQuickMessage()">
            Send
        </button>
    </div>
    
    <script>
        let ws = null;
        let sessionId = null;
        let agentName = window.AGENT_NAME || 'AI';
        let term = null;
        let fitAddon = null;
        
        function getSessionId() {
            return sessionId;
        }
        
        function initTerminal() {
            // Initialize xterm.js
            term = new Terminal({
                theme: {
                    background: '#0d1117',
                    foreground: '#c9d1d9',
                    cursor: '#58a6ff',
                    selection: '#264f78',
                    black: '#484f58',
                    red: '#ff7b72',
                    green: '#3fb950',
                    yellow: '#d29922',
                    blue: '#58a6ff',
                    magenta: '#bc8cff',
                    cyan: '#39c5cf',
                    white: '#c9d1d9',
                    brightBlack: '#6e7681',
                    brightRed: '#ffa198',
                    brightGreen: '#56d364',
                    brightYellow: '#e3b341',
                    brightBlue: '#79c0ff',
                    brightMagenta: '#d2a8ff',
                    brightCyan: '#56d4dd',
                    brightWhite: '#f0f6fc'
                },
                fontFamily: '"JetBrains Mono", "Fira Code", "SF Mono", "Monaco", "Cascadia Code", "Menlo", "DejaVu Sans Mono", "Liberation Mono", "Consolas", "Ubuntu Mono", monospace',
                fontSize: 13,
                lineHeight: 1.2,
                cursorBlink: true,
                cursorStyle: 'block',
                scrollback: 10000,
                convertEol: false,
                allowProposedApi: true,
                allowTransparency: false,
                altClickMovesCursor: true,
                rightClickSelectsWord: false,
                macOptionIsMeta: true,
                macOptionClickForcesSelection: false,
                logLevel: 'warn'
            });
            
            // Add fit addon
            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            
            // Add web links addon
            const webLinksAddon = new WebLinksAddon.WebLinksAddon();
            term.loadAddon(webLinksAddon);
            
            // Open terminal in container
            term.open(document.getElementById('xterm-container'));
            
            // Ensure proper fit after DOM is ready
            setTimeout(() => {
                fitAddon.fit();
            }, 100);
            
            // Handle terminal input
            term.onData((data) => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'input',
                        data: data
                    }));
                }
            });
            
            // Handle terminal resize
            term.onResize((size) => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'resize',
                        cols: size.cols,
                        rows: size.rows
                    }));
                }
            });
            
            // Auto-resize on window resize
            window.addEventListener('resize', () => {
                setTimeout(() => {
                    fitAddon.fit();
                }, 50);
            });
        }
        
        function initWebSocket() {
            // Get session ID from URL or generate
            const urlParams = new URLSearchParams(window.location.search);
            sessionId = urlParams.get('session') || 'default';
            
            // Get agent name from URL or use default
            agentName = urlParams.get('agent') || agentName;
            document.getElementById('agentBadge').textContent = agentName.toUpperCase();
            
            ws = new WebSocket(`ws://${window.location.host}/ws/${sessionId}`);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                addLogEntry('Connected to ' + agentName + ' agent', 'success');
                document.getElementById('statusText').textContent = 'Connected';
                
                // Force terminal resize after connection
                setTimeout(() => {
                    if (fitAddon) {
                        fitAddon.fit();
                    }
                }, 200);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addLogEntry('Connection error: ' + error, 'error');
                document.getElementById('statusText').textContent = 'Error';
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                addLogEntry('Session disconnected, reconnecting...', 'warning');
                document.getElementById('statusText').textContent = 'Disconnected';
                setTimeout(initWebSocket, 3000);
            };
        }
        
        function handleMessage(data) {
            switch(data.type) {
                case 'output':
                    if (data.source === 'pty') {
                        // Write raw PTY output directly to xterm (preserves ANSI codes)
                        term.write(data.content);
                    } else {
                        // Route non-PTY output to logs
                        addLogEntry(data.content, data.source === 'system' ? 'info' : 'info');
                    }
                    break;
                case 'prompt':
                    showPrompt(data.prompt);
                    break;
                case 'clear':
                    term.clear();
                    break;
            }
        }
        
        function clearTerminal() {
            term.clear();
        }
        
        function addLogEntry(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            
            const timestamp = document.createElement('span');
            timestamp.className = 'log-timestamp';
            timestamp.textContent = new Date().toLocaleTimeString();
            
            entry.appendChild(timestamp);
            entry.appendChild(document.createTextNode(message));
            
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logContent').innerHTML = '';
        }
        
        function toggleLogs() {
            const logPanel = document.getElementById('logPanel');
            const jsonlPanel = document.getElementById('jsonlPanel');
            const isHidden = logPanel.classList.contains('hidden');
            
            if (isHidden) {
                logPanel.classList.remove('hidden');
                jsonlPanel.style.display = 'none';
                document.getElementById('logsToggle').style.background = 'var(--accent)';
                document.getElementById('jsonlToggle').style.background = '';
            } else {
                logPanel.classList.add('hidden');
                document.getElementById('logsToggle').style.background = '';
            }
            
            // Resize terminal after panel toggle
            setTimeout(() => {
                if (fitAddon) {
                    fitAddon.fit();
                }
            }, 350);
        }
        
        function toggleJsonl() {
            const logPanel = document.getElementById('logPanel');
            const jsonlPanel = document.getElementById('jsonlPanel');
            const isHidden = jsonlPanel.style.display === 'none';
            
            if (isHidden) {
                jsonlPanel.style.display = 'flex';
                logPanel.classList.add('hidden');
                document.getElementById('jsonlToggle').style.background = 'var(--accent)';
                document.getElementById('logsToggle').style.background = '';
                
                // Start streaming JSONL if not already started
                if (!window.jsonlEventSource) {
                    startJsonlStream();
                }
            } else {
                jsonlPanel.style.display = 'none';
                document.getElementById('jsonlToggle').style.background = '';
            }
            
            // Resize terminal after panel toggle
            setTimeout(() => {
                if (fitAddon) {
                    fitAddon.fit();
                }
            }, 350);
        }
        
        function clearJsonl() {
            document.getElementById('jsonlContent').innerHTML = '';
        }
        
        function parseMarkdown(text) {
            if (!text) return '';
            
            // Escape HTML to prevent XSS, then apply markdown
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;');
            
            // Code blocks (``` or `` or `)
            html = html
                .replace(/```(\w+)?\n([\s\S]*?)\n```/g, '<pre style="background: var(--bg-primary); padding: 8px; border-radius: 4px; overflow-x: auto; border-left: 3px solid var(--accent); margin: 8px 0;"><code>$2</code></pre>')
                .replace(/`([^`\n]+)`/g, '<code style="background: var(--bg-primary); padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>');
            
            // Headers
            html = html
                .replace(/^### (.*$)/gm, '<h3 style="color: var(--accent); margin: 12px 0 8px 0; font-size: 16px;">$1</h3>')
                .replace(/^## (.*$)/gm, '<h2 style="color: var(--accent); margin: 16px 0 10px 0; font-size: 18px;">$1</h2>')
                .replace(/^# (.*$)/gm, '<h1 style="color: var(--accent); margin: 20px 0 12px 0; font-size: 20px;">$1</h1>');
            
            // Bold and italic
            html = html
                .replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: bold;">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em style="font-style: italic;">$1</em>');
            
            // Lists
            html = html
                .replace(/^\s*[-*+]\s+(.*)$/gm, '<li style="margin: 2px 0;">$1</li>')
                .replace(/(<li.*<\/li>)/s, '<ul style="margin: 8px 0; padding-left: 20px;">$1</ul>')
                .replace(/^\s*(\d+)\.\s+(.*)$/gm, '<li style="margin: 2px 0;">$2</li>');
            
            // Line breaks - convert \n to <br> for remaining newlines
            html = html.replace(/\n/g, '<br>');
            
            // Links (basic)
            html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" style="color: var(--accent); text-decoration: underline;" target="_blank">$1</a>');
            
            return html;
        }
        
        function createStructuredJsonView(jsonData) {
            const container = document.createElement('div');
            
            // Header with type and timestamp
            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            header.style.marginBottom = '8px';
            header.style.paddingBottom = '4px';
            header.style.borderBottom = '1px solid var(--border)';
            
            const typeSpan = document.createElement('span');
            typeSpan.style.fontWeight = 'bold';
            typeSpan.style.fontSize = '13px';
            
            // Style based on message type
            switch(jsonData.type) {
                case 'user':
                    typeSpan.style.color = 'var(--success)';
                    typeSpan.textContent = 'üë§ USER';
                    break;
                case 'assistant':
                    typeSpan.style.color = 'var(--accent)';
                    typeSpan.textContent = 'ü§ñ ASSISTANT';
                    break;
                case 'summary':
                    typeSpan.style.color = 'var(--warning)';
                    typeSpan.textContent = 'üìã SUMMARY';
                    break;
                default:
                    typeSpan.style.color = 'var(--text-secondary)';
                    typeSpan.textContent = jsonData.type?.toUpperCase() || 'DATA';
            }
            
            const timestampSpan = document.createElement('span');
            timestampSpan.style.color = 'var(--text-secondary)';
            timestampSpan.style.fontSize = '11px';
            if (jsonData.timestamp) {
                const date = new Date(jsonData.timestamp);
                timestampSpan.textContent = date.toLocaleTimeString();
            }
            
            header.appendChild(typeSpan);
            header.appendChild(timestampSpan);
            container.appendChild(header);
            
            // Content based on type
            const contentDiv = document.createElement('div');
            contentDiv.style.fontSize = '12px';
            contentDiv.style.lineHeight = '1.4';
            
            if (jsonData.type === 'summary') {
                contentDiv.style.color = 'var(--text-primary)';
                contentDiv.style.whiteSpace = 'pre-wrap';
                contentDiv.textContent = jsonData.summary;
            } else if (jsonData.message) {
                if (jsonData.message.content) {
                    if (typeof jsonData.message.content === 'string') {
                        contentDiv.style.color = 'var(--text-primary)';
                        contentDiv.innerHTML = parseMarkdown(jsonData.message.content);
                    } else if (Array.isArray(jsonData.message.content)) {
                        // Handle complex content arrays
                        jsonData.message.content.forEach((item, index) => {
                            const itemDiv = document.createElement('div');
                            if (index > 0) itemDiv.style.marginTop = '4px';
                            
                            if (item.type === 'text') {
                                itemDiv.style.color = 'var(--text-primary)';
                                itemDiv.innerHTML = parseMarkdown(item.text);
                            } else if (item.type === 'tool_use') {
                                itemDiv.style.color = 'var(--accent)';
                                itemDiv.style.fontStyle = 'italic';
                                itemDiv.textContent = `üîß Tool: ${item.name}`;
                            } else if (item.type === 'tool_result') {
                                itemDiv.style.color = 'var(--success)';
                                itemDiv.style.fontStyle = 'italic';
                                itemDiv.textContent = '‚úÖ Tool result';
                            } else {
                                itemDiv.style.color = 'var(--text-secondary)';
                                itemDiv.textContent = JSON.stringify(item, null, 2);
                            }
                            contentDiv.appendChild(itemDiv);
                        });
                    }
                }
                
                // Show model info for assistant messages
                if (jsonData.type === 'assistant' && jsonData.message.model) {
                    const modelDiv = document.createElement('div');
                    modelDiv.style.marginTop = '4px';
                    modelDiv.style.fontSize = '10px';
                    modelDiv.style.color = 'var(--text-secondary)';
                    modelDiv.textContent = `Model: ${jsonData.message.model}`;
                    contentDiv.appendChild(modelDiv);
                }
            } else {
                // Fallback: show raw JSON
                const pre = document.createElement('pre');
                pre.style.fontSize = '10px';
                pre.style.color = 'var(--text-secondary)';
                pre.style.overflow = 'auto';
                pre.style.whiteSpace = 'pre-wrap';
                pre.textContent = JSON.stringify(jsonData, null, 2);
                contentDiv.appendChild(pre);
            }
            
            container.appendChild(contentDiv);
            return container;
        }
        
        function startJsonlStream() {
            const sessionId = getSessionId();
            if (!sessionId) return;
            
            // Close existing connection if any
            if (window.jsonlEventSource) {
                window.jsonlEventSource.close();
            }
            
            // Create new EventSource for SSE
            window.jsonlEventSource = new EventSource(`/api/sessions/${sessionId}/stream`);
            
            window.jsonlEventSource.onmessage = (event) => {
                const content = document.getElementById('jsonlContent');
                const entry = document.createElement('div');
                entry.style.marginBottom = '8px';
                entry.style.padding = '8px';
                entry.style.borderBottom = '1px solid var(--border)';
                entry.style.borderRadius = '4px';
                entry.style.backgroundColor = 'var(--bg-tertiary)';
                
                // Check if it's the streaming marker
                if (event.data === '[STREAMING]') {
                    entry.style.color = 'var(--accent)';
                    entry.style.fontStyle = 'italic';
                    entry.textContent = '--- Live streaming enabled ---';
                } else {
                    try {
                        const jsonData = JSON.parse(event.data);
                        entry.appendChild(createStructuredJsonView(jsonData));
                    } catch (e) {
                        // Fallback to raw text if not valid JSON
                        entry.style.color = 'var(--text-primary)';
                        entry.style.fontFamily = 'monospace';
                        entry.style.fontSize = '12px';
                        entry.textContent = event.data;
                    }
                }
                
                content.appendChild(entry);
                content.scrollTop = content.scrollHeight;
            };
            
            window.jsonlEventSource.onerror = (error) => {
                console.error('JSONL stream error:', error);
                addLogEntry('JSONL stream error', 'error');
            };
        }
        
        function showPrompt(promptData) {
            const overlay = document.getElementById('promptOverlay');
            const content = document.getElementById('promptContent');
            const input = document.getElementById('promptInput');
            
            content.textContent = promptData.prompt || '';
            input.innerHTML = '';
            
            switch(promptData.type) {
                case 'TextInput':
                    createTextInput(input, promptData);
                    break;
                case 'Confirmation':
                    createConfirmation(input, promptData);
                    break;
                case 'MultiSelect':
                    createMultiSelect(input, promptData);
                    break;
                case 'SingleSelect':
                    createSingleSelect(input, promptData);
                    break;
                case 'FilePath':
                    createFilePath(input, promptData);
                    break;
            }
            
            overlay.classList.add('active');
        }
        
        function hidePrompt() {
            document.getElementById('promptOverlay').classList.remove('active');
        }
        
        function createTextInput(container, data) {
            const group = document.createElement('div');
            group.className = 'input-group';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'text-input';
            input.placeholder = data.default || 'Enter your response...';
            input.autofocus = true;
            
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.innerHTML = 'Submit ‚Üí';
            btn.onclick = () => sendResponse(input.value);
            
            input.onkeypress = (e) => {
                if (e.key === 'Enter') sendResponse(input.value);
            };
            
            group.appendChild(input);
            group.appendChild(btn);
            container.appendChild(group);
            
            input.focus();
        }
        
        function createConfirmation(container, data) {
            const group = document.createElement('div');
            group.className = 'btn-group';
            
            const yesBtn = document.createElement('button');
            yesBtn.className = 'btn';
            yesBtn.innerHTML = '‚úì Yes';
            yesBtn.onclick = () => sendResponse('y');
            
            const noBtn = document.createElement('button');
            noBtn.className = 'btn btn-secondary';
            noBtn.innerHTML = '‚úó No';
            noBtn.onclick = () => sendResponse('n');
            
            group.appendChild(yesBtn);
            group.appendChild(noBtn);
            container.appendChild(group);
        }
        
        function createMultiSelect(container, data) {
            const grid = document.createElement('div');
            grid.className = 'choice-grid';
            
            data.options.forEach((option, index) => {
                const item = document.createElement('div');
                item.className = 'choice-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `option-${index}`;
                checkbox.checked = data.selected?.includes(index);
                
                const label = document.createElement('label');
                label.htmlFor = `option-${index}`;
                label.textContent = option;
                label.style.cursor = 'pointer';
                label.style.flex = '1';
                
                item.appendChild(checkbox);
                item.appendChild(label);
                
                item.onclick = () => {
                    checkbox.checked = !checkbox.checked;
                    item.classList.toggle('selected', checkbox.checked);
                };
                
                if (checkbox.checked) item.classList.add('selected');
                
                grid.appendChild(item);
            });
            
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.innerHTML = 'Confirm Selection ‚Üí';
            btn.onclick = () => {
                const selected = [];
                grid.querySelectorAll('input:checked').forEach((cb) => {
                    selected.push(parseInt(cb.id.split('-')[1]));
                });
                sendResponse(selected);
            };
            
            container.appendChild(grid);
            container.appendChild(btn);
        }
        
        function createSingleSelect(container, data) {
            const grid = document.createElement('div');
            grid.className = 'choice-grid';
            
            data.options.forEach((option, index) => {
                const item = document.createElement('div');
                item.className = 'choice-item';
                
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'single-select';
                radio.id = `option-${index}`;
                radio.checked = index === data.default;
                
                const label = document.createElement('label');
                label.htmlFor = `option-${index}`;
                label.textContent = option;
                label.style.cursor = 'pointer';
                label.style.flex = '1';
                
                item.appendChild(radio);
                item.appendChild(label);
                
                item.onclick = () => {
                    radio.checked = true;
                    grid.querySelectorAll('.choice-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                };
                
                if (radio.checked) item.classList.add('selected');
                
                grid.appendChild(item);
            });
            
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.innerHTML = 'Select ‚Üí';
            btn.onclick = () => {
                const selected = grid.querySelector('input:checked');
                if (selected) {
                    sendResponse(parseInt(selected.id.split('-')[1]));
                }
            };
            
            container.appendChild(grid);
            container.appendChild(btn);
        }
        
        function createFilePath(container, data) {
            const group = document.createElement('div');
            group.className = 'input-group';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'text-input';
            input.placeholder = data.default || 'Enter file path...';
            input.autofocus = true;
            
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.innerHTML = 'üìÅ Select';
            btn.onclick = () => sendResponse(input.value);
            
            input.onkeypress = (e) => {
                if (e.key === 'Enter') sendResponse(input.value);
            };
            
            group.appendChild(input);
            group.appendChild(btn);
            container.appendChild(group);
            
            input.focus();
        }
        
        function sendResponse(response) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'response',
                    data: response
                }));
                
                // Response will be echoed by the terminal naturally
                hidePrompt();
            }
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            initTerminal();
            initWebSocket();
            addLogEntry('CodeMux session initialized', 'info');
        });
        
        function sendQuickMessage() {
            const input = document.getElementById('quickInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'input',
                    data: message
                }));
                
                // Input will be echoed by the terminal naturally
                input.value = '';
            }
        }
        
        function toggleSettings() {
            // TODO: Implement settings panel
            alert('Settings panel coming soon!');
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                clearTerminal();
            }
        });
        
        // Quick input enter key
        document.getElementById('quickInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendQuickMessage();
            }
        });
    </script>
</body>
</html>