# CodeMux 0.1 Architecture: Server-Client Model

## Overview

CodeMux 0.1 introduces a server-client architecture similar to tmux, where a central server manages all AI coding sessions and multiple clients can connect to these sessions.

## Architecture Components

### Server (`codemux server`)
- **Central Session Manager**: Manages all AI agent sessions (Claude, Gemini, Aider, etc.)
- **Web Interface**: Single web server instance serving the React Native UI
- **Session Persistence**: Sessions continue running even when clients disconnect
- **Multi-client Support**: Multiple clients can attach to the same session
- **Optional Daemon**: Can be installed as system daemon but not required

### Client (`codemux run`, `codemux attach`)
- **Lightweight Interface**: Connects to server for session management
- **TUI Client**: Terminal interface that communicates with server sessions
- **Auto-start**: Automatically starts server if not running
- **Session Attachment**: Can attach/detach from sessions without termination

## Command Structure

### Server Commands
```bash
# Start server explicitly
codemux server

# Check server status  
codemux server status

# Stop server
codemux server stop
```

### Session Commands
```bash
# Auto-start server + create new session + attach TUI
codemux run claude

# List all sessions on server
codemux list

# Attach to existing session
codemux attach <session-id>

# Kill specific session
codemux kill-session <session-id>

# Create named session
codemux new-session -s "project-name" claude
```

### Project Commands  
```bash
# Add project to server
codemux add-project /path/to/project --name "My Project"

# List projects
codemux list-projects
```

## Session Lifecycle

1. **Session Creation**: Always through server's SessionManager
2. **Client Attachment**: TUI connects to server via WebSocket
3. **Session Persistence**: Sessions survive client disconnection
4. **Multi-client Access**: Multiple clients can attach to same session
5. **Web Access**: All sessions accessible via single web interface

## Communication Flow

```
[Client] --HTTP--> [Server] --PTY--> [AI Agent]
    |                 |
    +--WebSocket------+
    |                 |
[TUI Client]    [Web Interface]
```

## Configuration

### Server Configuration (`~/.config/codemux/config.toml`)
```toml
[server]
port = 8765
data_dir = "~/.local/share/codemux"
pid_file = "~/.local/share/codemux/server.pid"

[whitelist]
agents = ["claude", "gemini", "aider", "cursor", "continue"]

[web]
static_dir = null  # Uses embedded assets
```

## Benefits

1. **Resource Efficiency**: Single server instance for all sessions
2. **Session Persistence**: Sessions survive client crashes/disconnections
3. **Multi-client Access**: Collaborative session sharing
4. **Simplified Architecture**: Centralized session management
5. **tmux-like UX**: Familiar workflow for developers
6. **Web Integration**: Unified web interface for all sessions

## Migration from 0.0.x

### Backward Compatibility
- `codemux run claude` continues to work (now uses server internally)
- Existing configuration files are automatically migrated
- Web interface remains at same URL structure

### Breaking Changes
- `codemux daemon` renamed to `codemux server`
- Sessions are now persistent by default
- Multiple sessions share single web server instance

## Implementation Details

### Server Auto-Start
When `codemux run` is executed:
1. Check if server is running (PID file + port connectivity)
2. If not running, start server in background
3. Wait for server readiness
4. Create session via server API
5. Attach TUI to session

### Session Management
- **Session Storage**: In-memory with optional persistence
- **Session IDs**: UUID-based with optional naming
- **Project Association**: Sessions can be linked to projects
- **Status Tracking**: Running, stopped, failed states

### Web Interface Integration
- **Single Port**: All sessions accessible via server port
- **Session Switching**: Web UI can switch between sessions
- **Real-time Updates**: WebSocket updates for all connected clients
- **Mobile Support**: React Native Web interface works on all devices

## Security

### Whitelist System
- Only approved AI agents can be executed
- Configuration-based agent approval
- Process isolation for each agent

### Network Security
- Server binds to localhost by default
- Optional configuration for remote access
- Session isolation between clients

## Performance

### Resource Usage
- Single server process vs multiple per session
- Shared web server reduces memory footprint  
- Session pooling and management
- Efficient WebSocket communication

### Scalability
- Multiple concurrent sessions supported
- Client connection pooling
- Optimized PTY handling
- Background session execution

This architecture provides a solid foundation for AI-driven development workflows while maintaining simplicity and efficiency.