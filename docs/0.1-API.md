# CodeMux 0.1 API Documentation

## Overview

CodeMux 0.1 server exposes a REST API for session and project management, along with WebSocket endpoints for real-time communication with AI agent sessions.

## Base URL

- **Local**: `http://localhost:8765` (default)
- **Configurable**: Via `server.port` in config

## Authentication

Currently, no authentication is required for local access. Future versions may add authentication for remote access.

## REST API Endpoints

### Sessions

#### Create Session
```http
POST /api/sessions
Content-Type: application/json

{
  "agent": "claude",
  "args": ["--session-id", "custom-id"],
  "project_id": "optional-project-id"
}
```

**Response:**
```json
{
  "id": "abc123-def456-789",
  "agent": "claude", 
  "project": "project-id",
  "status": "running"
}
```

#### Get Session
```http
GET /api/sessions/{session_id}
```

**Response:**
```json
{
  "id": "abc123-def456-789",
  "agent": "claude",
  "project": null,
  "status": "running"
}
```

#### List Sessions
```http
GET /api/sessions
```

**Response:**
```json
[
  {
    "id": "abc123-def456-789",
    "agent": "claude",
    "project": null, 
    "status": "running"
  },
  {
    "id": "def456-ghi789-012",
    "agent": "gemini",
    "project": "project-123",
    "status": "running"
  }
]
```

#### Delete Session
```http
DELETE /api/sessions/{session_id}
```

**Response:**
```http
204 No Content
```

#### Stream Session JSONL
```http
GET /api/sessions/{session_id}/stream
Accept: text/event-stream
```

**Response:** Server-sent events with JSONL data
```
data: {"type": "conversation", "content": "Hello", "timestamp": "2024-01-01T12:00:00Z"}
data: {"type": "response", "content": "Hi there!", "timestamp": "2024-01-01T12:00:01Z"}
```

### Projects

#### List Projects
```http
GET /api/projects
```

**Response:**
```json
[
  {
    "id": "project-123",
    "name": "My Web App", 
    "path": "/Users/dev/my-app",
    "sessions": [
      {
        "id": "session-456",
        "agent": "claude",
        "status": "running"
      }
    ]
  }
]
```

#### Create Project
```http
POST /api/projects
Content-Type: application/json

{
  "name": "New Project",
  "path": "/path/to/project"
}
```

**Response:**
```json
{
  "id": "new-project-id",
  "name": "New Project",
  "path": "/path/to/project" 
}
```

### Git Integration

#### Get Git Status
```http
GET /api/sessions/{session_id}/git/status
```

**Response:**
```json
{
  "branch": "main",
  "staged": ["file1.js", "file2.py"],
  "unstaged": ["file3.md"],
  "untracked": ["new_file.txt"]
}
```

#### Get Git Diff
```http
GET /api/sessions/{session_id}/git/diff
```

**Response:**
```json
{
  "diff": "@@ -1,3 +1,4 @@\n console.log('hello');\n+console.log('world');\n",
  "files": [
    {
      "path": "src/index.js",
      "status": "modified",
      "additions": 1,
      "deletions": 0
    }
  ]
}
```

#### Get File Diff
```http
GET /api/sessions/{session_id}/git/diff/src/index.js
```

**Response:**
```json
{
  "path": "src/index.js",
  "diff": "@@ -1,3 +1,4 @@\n console.log('hello');\n+console.log('world');\n",
  "status": "modified",
  "additions": 1, 
  "deletions": 0
}
```

## WebSocket API

### Session Terminal Connection

#### Connect to Session
```
ws://localhost:8765/ws/{session_id}
```

#### Message Types

##### Client to Server

**PTY Input (Raw)**
```json
{
  "type": "input",
  "data": {
    "input": {
      "Raw": {
        "data": [72, 101, 108, 108, 111],
        "client_id": "client-123"
      }
    }
  }
}
```

**PTY Input (Key Events)**
```json
{
  "type": "input", 
  "data": {
    "input": {
      "Key": {
        "event": {
          "code": "Char",
          "char": "h",
          "modifiers": {
            "shift": false,
            "ctrl": false,
            "alt": false,
            "meta": false
          }
        },
        "client_id": "client-123"
      }
    }
  }
}
```

**Resize Terminal**
```json
{
  "type": "resize",
  "rows": 24,
  "cols": 80
}
```

**Request Keyframe**
```json
{
  "type": "request_keyframe"
}
```

##### Server to Client

**PTY Output**
```json
{
  "type": "output",
  "data": [72, 101, 108, 108, 111],
  "timestamp": "2024-01-01T12:00:00Z"
}
```

**Grid Update (Keyframe)**
```json
{
  "type": "grid",
  "data": {
    "Keyframe": {
      "size": {"rows": 24, "cols": 80},
      "cells": {
        "(0,0)": {
          "char": "H",
          "fg_color": null,
          "bg_color": null,
          "bold": false,
          "italic": false,
          "underline": false,
          "reverse": false
        }
      },
      "cursor": [0, 1],
      "cursor_visible": true,
      "timestamp": "2024-01-01T12:00:00Z"
    }
  }
}
```

**Grid Update (Diff)**
```json
{
  "type": "grid",
  "data": {
    "Diff": {
      "changes": [
        [0, 5, {
          "char": "!",
          "fg_color": {"Rgb": {"r": 255, "g": 0, "b": 0}},
          "bg_color": null,
          "bold": true,
          "italic": false,
          "underline": false,
          "reverse": false
        }]
      ],
      "cursor": [0, 6],
      "cursor_visible": true,
      "timestamp": "2024-01-01T12:00:00Z"
    }
  }
}
```

**Size Update**
```json
{
  "type": "size",
  "rows": 30,
  "cols": 120
}
```

## Data Types

### GridCell
```json
{
  "char": "A",
  "fg_color": "Default" | {"Indexed": 15} | {"Palette": 196} | {"Rgb": {"r": 255, "g": 255, "b": 255}},
  "bg_color": null,
  "bold": false,
  "italic": false, 
  "underline": false,
  "reverse": false
}
```

### KeyCode
```json
"Char" | "Backspace" | "Enter" | "Left" | "Right" | "Up" | "Down" | 
"Home" | "End" | "PageUp" | "PageDown" | "Tab" | "Delete" | "Insert" |
{"F": 1} | "Esc"
```

### KeyModifiers
```json
{
  "shift": false,
  "ctrl": false,
  "alt": false,
  "meta": false
}
```

## Error Responses

### Standard Error Format
```json
{
  "error": "Session not found",
  "code": "SESSION_NOT_FOUND",
  "details": "Session with ID 'invalid-id' does not exist"
}
```

### Common Error Codes
- `SESSION_NOT_FOUND` - Session ID doesn't exist
- `AGENT_NOT_WHITELISTED` - AI agent not in whitelist
- `PROJECT_NOT_FOUND` - Project ID doesn't exist  
- `INVALID_INPUT` - Malformed request data
- `SERVER_ERROR` - Internal server error

## Rate Limiting

Currently no rate limiting is implemented. Future versions may add:
- Request rate limits per client
- WebSocket message throttling
- Session creation limits

## Examples

### Creating and Connecting to Session

```javascript
// Create session
const response = await fetch('http://localhost:8765/api/sessions', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    agent: 'claude',
    args: []
  })
});

const session = await response.json();
console.log('Created session:', session.id);

// Connect WebSocket
const ws = new WebSocket(`ws://localhost:8765/ws/${session.id}`);

ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  if (message.type === 'grid') {
    // Handle terminal grid updates
    updateTerminal(message.data);
  }
};

// Send input
ws.send(JSON.stringify({
  type: 'input',
  data: {
    input: {
      Raw: {
        data: Array.from(new TextEncoder().encode('hello\r')),
        client_id: 'web-client'
      }
    }
  }
}));
```

This API provides complete programmatic access to CodeMux server functionality, enabling custom clients and integrations.